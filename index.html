<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Connect Friends</title>
<style>
  :root {
    --bg1: #0d0015;
    --bg2: #1a0030;
    --bg3: #2d1052;
    --surface: rgba(30,10,60,0.7);
    --surface2: rgba(50,20,80,0.6);
    --accent: #a855f7;
    --accent2: #c084fc;
    --accent3: #d8b4fe;
    --text: #ffffff;
    --text2: #c4b5d9;
    --danger: #ef4444;
    --success: #10b981;
    --warning: #f59e0b;
    --maybe: #f59e0b;
    --cant: #ef4444;
    --going: #10b981;
    --border: rgba(168,85,247,0.25);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family:'Segoe UI',system-ui,sans-serif; color:var(--text); min-height:100vh;
    background: linear-gradient(135deg, #0d0015 0%, #1a0033 20%, #2d1052 40%, #3b1578 55%, #4a1a8a 65%, #2d1052 80%, #1a0033 100%);
    background-attachment: fixed;
  }
  body::before {
    content:''; position:fixed; inset:0; z-index:-1;
    background: radial-gradient(ellipse at 20% 20%, rgba(139,92,246,0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(168,85,247,0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(192,132,252,0.05) 0%, transparent 70%);
  }

  /* Toast */
  #toast-container { position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px; }
  .toast {
    background: linear-gradient(135deg, #7c3aed, #6d28d9);
    color:#fff; padding:14px 20px; border-radius:12px; min-width:280px; max-width:340px;
    box-shadow: 0 8px 32px rgba(124,58,237,0.4);
    animation: slideIn 0.4s cubic-bezier(0.16,1,0.3,1), fadeOut 0.4s 4.6s forwards;
    display:flex; align-items:flex-start; gap:12px; backdrop-filter:blur(10px);
  }
  .toast.reminder { background: linear-gradient(135deg, #f59e0b, #d97706); }
  .toast-icon { font-size:20px; margin-top:2px; }
  .toast-content { flex:1; }
  .toast-title { font-weight:700; font-size:14px; }
  .toast-msg { font-size:12px; opacity:0.9; margin-top:2px; }
  @keyframes slideIn { from{transform:translateX(120%);opacity:0} to{transform:translateX(0);opacity:1} }
  @keyframes fadeOut { to{transform:translateX(120%);opacity:0} }

  /* Header */
  header {
    background: rgba(20,5,40,0.8);
    border-bottom:1px solid var(--border);
    padding:16px 24px; display:flex; align-items:center; justify-content:space-between;
    backdrop-filter:blur(20px);
  }
  .header-left { display:flex; align-items:center; gap:12px; }
  .menu-btn {
    display:none; background:rgba(50,20,80,0.8); border:1px solid var(--border); color:var(--text);
    width:40px; height:40px; border-radius:10px; cursor:pointer; font-size:20px;
    align-items:center; justify-content:center; transition:0.2s; flex-shrink:0;
  }
  .menu-btn:hover { background:var(--accent); }
  .logo { display:flex; align-items:center; gap:12px; }
  .logo-icon {
    width:42px; height:42px; background:linear-gradient(135deg,#a855f7,#7c3aed);
    border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px;
    box-shadow: 0 4px 15px rgba(168,85,247,0.4);
  }
  .logo h1 { font-size:22px; font-weight:700; background:linear-gradient(135deg,#c084fc,#e9d5ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  .user-area { display:flex; align-items:center; gap:12px; }
  .user-select { background:rgba(50,20,80,0.8); color:var(--text); border:1px solid var(--border); padding:8px 14px; border-radius:10px; font-size:14px; cursor:pointer; }
  .user-select:focus { outline:none; border-color:var(--accent); }
  .user-select option { background:#1a0033; }
  .notification-bell { position:relative; background:rgba(50,20,80,0.8); border:1px solid var(--border); color:var(--text); width:40px; height:40px; border-radius:10px; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; transition:0.2s; flex-shrink:0; }
  .notification-bell:hover { background:var(--accent); }
  .notification-bell .badge { position:absolute; top:-4px; right:-4px; background:var(--danger); color:#fff; font-size:10px; width:18px; height:18px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; }

  /* Layout */
  .app { display:flex; height:calc(100vh - 75px); }

  /* Sidebar */
  .sidebar {
    width:290px; background:rgba(15,5,30,0.6); border-right:1px solid var(--border);
    padding:20px; display:flex; flex-direction:column; gap:20px; overflow-y:auto;
    backdrop-filter:blur(10px); flex-shrink:0;
  }
  .main { flex:1; padding:24px; overflow-y:auto; }

  /* Sidebar overlay for mobile */
  .sidebar-overlay {
    display:none; position:fixed; inset:0; background:rgba(5,0,15,0.6); z-index:500;
    backdrop-filter:blur(4px);
  }
  .sidebar-overlay.active { display:block; }

  .section-title { font-size:11px; text-transform:uppercase; letter-spacing:1.5px; color:var(--text2); margin-bottom:8px; font-weight:600; }
  .member-list { display:flex; flex-direction:column; gap:6px; }
  .member {
    display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px;
    cursor:pointer; transition:0.2s;
  }
  .member:hover { background:rgba(168,85,247,0.1); }
  .member-avatar {
    width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center;
    font-size:13px; font-weight:700; color:#fff; flex-shrink:0;
  }
  .member-name { font-size:14px; font-weight:500; }
  .member-status { font-size:11px; color:var(--text2); }

  .add-member-input { display:flex; gap:6px; margin-top:4px; }
  .add-member-input input {
    flex:1; background:rgba(50,20,80,0.6); border:1px solid var(--border); color:var(--text);
    padding:8px 12px; border-radius:8px; font-size:13px;
  }
  .add-member-input input:focus { outline:none; border-color:var(--accent); }
  .add-member-input button {
    background:var(--accent); color:#fff; border:none; padding:8px 12px; border-radius:8px;
    cursor:pointer; font-weight:600; font-size:13px; transition:0.2s;
  }
  .add-member-input button:hover { background:#9333ea; }

  .sidebar-close {
    display:none; background:none; border:none; color:var(--text); font-size:24px;
    cursor:pointer; align-self:flex-end; padding:4px 8px; margin:-8px -8px 0 0;
  }

  .upcoming-event {
    padding:10px 12px; background:rgba(50,20,80,0.4); border-radius:10px;
    border-left:3px solid var(--accent); margin-bottom:8px; cursor:pointer; transition:0.2s;
    backdrop-filter:blur(5px);
  }
  .upcoming-event:hover { transform:translateX(4px); background:rgba(50,20,80,0.6); }
  .upcoming-event .ue-title { font-size:13px; font-weight:600; }
  .upcoming-event .ue-time { font-size:11px; color:var(--text2); margin-top:2px; }
  .upcoming-event .ue-people { font-size:11px; color:var(--accent2); margin-top:4px; }
  .upcoming-event .ue-rsvp { font-size:10px; margin-top:4px; display:flex; gap:8px; }
  .ue-rsvp-tag { padding:2px 8px; border-radius:10px; font-weight:600; }

  /* Calendar */
  .cal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
  .cal-header h2 { font-size:26px; font-weight:700; }
  .cal-nav { display:flex; gap:8px; }
  .cal-nav button {
    background:rgba(50,20,80,0.6); border:1px solid var(--border); color:var(--text);
    width:38px; height:38px; border-radius:10px; cursor:pointer; font-size:16px;
    display:flex; align-items:center; justify-content:center; transition:0.2s;
  }
  .cal-nav button:hover { background:var(--accent); border-color:var(--accent); }

  .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
  .cal-day-name { text-align:center; font-size:12px; color:var(--text2); padding:8px 0; font-weight:600; text-transform:uppercase; letter-spacing:1px; }
  .cal-day {
    min-height:100px; background:rgba(25,10,50,0.5); border:1px solid transparent; border-radius:12px;
    padding:8px; cursor:pointer; transition:0.2s; position:relative; backdrop-filter:blur(5px);
  }
  .cal-day:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 4px 20px rgba(168,85,247,0.2); }
  .cal-day.today { border-color:var(--accent); background:rgba(168,85,247,0.12); box-shadow:0 0 20px rgba(168,85,247,0.15); }
  .cal-day.other-month { opacity:0.3; }
  .cal-day .day-num { font-size:13px; font-weight:600; margin-bottom:4px; }
  .cal-day.today .day-num { color:var(--accent3); }
  .cal-event {
    font-size:10px; padding:3px 6px; border-radius:6px; margin-bottom:3px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#fff; font-weight:500; cursor:pointer;
  }
  .cal-event:hover { filter:brightness(1.2); }

  /* Modal */
  .modal-overlay {
    display:none; position:fixed; inset:0; background:rgba(5,0,15,0.7); z-index:1000;
    align-items:center; justify-content:center; backdrop-filter:blur(6px);
  }
  .modal-overlay.active { display:flex; }
  .modal {
    background: linear-gradient(145deg, rgba(30,10,60,0.95), rgba(20,5,40,0.98));
    border:1px solid var(--border); border-radius:20px;
    padding:28px; width:460px; max-width:92vw; max-height:90vh; overflow-y:auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(168,85,247,0.1);
    animation: modalIn 0.3s cubic-bezier(0.16,1,0.3,1);
  }
  @keyframes modalIn { from{transform:scale(0.9) translateY(20px);opacity:0} to{transform:scale(1) translateY(0);opacity:1} }
  .modal h3 { font-size:20px; margin-bottom:20px; font-weight:700; }
  .form-group { margin-bottom:16px; }
  .form-group label { display:block; font-size:12px; color:var(--text2); margin-bottom:6px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
  .form-group input, .form-group select, .form-group textarea {
    width:100%; background:rgba(50,20,80,0.5); border:1px solid var(--border); color:var(--text);
    padding:10px 14px; border-radius:10px; font-size:14px; font-family:inherit;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 10px rgba(168,85,247,0.2); }
  .form-group textarea { resize:vertical; min-height:60px; }
  .form-group input[type="date"]::-webkit-calendar-picker-indicator,
  .form-group input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(0.7); }

  .people-checkboxes { display:flex; flex-wrap:wrap; gap:8px; }
  .people-checkboxes label {
    display:flex; align-items:center; gap:6px; padding:6px 12px;
    background:rgba(50,20,80,0.5); border:1px solid var(--border); border-radius:20px;
    cursor:pointer; font-size:13px; transition:0.2s; text-transform:none; letter-spacing:0;
  }
  .people-checkboxes label:has(input:checked) { background:var(--accent); border-color:var(--accent); }
  .people-checkboxes label input { display:none; }

  .reminder-options { display:flex; flex-wrap:wrap; gap:6px; }
  .reminder-options label {
    padding:6px 12px; background:rgba(50,20,80,0.5); border:1px solid var(--border);
    border-radius:20px; cursor:pointer; font-size:12px; transition:0.2s; text-transform:none; letter-spacing:0;
  }
  .reminder-options label:has(input:checked) { background:var(--warning); border-color:var(--warning); color:#000; }
  .reminder-options label input { display:none; }

  .modal-actions { display:flex; gap:10px; margin-top:20px; }
  .btn {
    padding:10px 20px; border-radius:10px; border:none; font-size:14px; font-weight:600;
    cursor:pointer; transition:0.2s; flex:1;
  }
  .btn-primary { background:linear-gradient(135deg,#a855f7,#7c3aed); color:#fff; }
  .btn-primary:hover { transform:translateY(-1px); box-shadow:0 4px 20px rgba(168,85,247,0.4); }
  .btn-secondary { background:rgba(50,20,80,0.6); color:var(--text); border:1px solid var(--border); }
  .btn-secondary:hover { background:rgba(70,30,100,0.6); }
  .btn-danger { background:var(--danger); color:#fff; flex:0; padding:10px 16px; }
  .btn-danger:hover { background:#dc2626; }

  /* Event detail */
  .event-detail-header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
  .event-color-dot { width:14px; height:14px; border-radius:50%; flex-shrink:0; }
  .event-detail-time { color:var(--text2); font-size:14px; margin-bottom:12px; }
  .event-detail-desc { color:var(--text2); font-size:14px; margin-bottom:16px; line-height:1.5; }
  .event-detail-reminder { font-size:12px; color:var(--warning); margin-bottom:16px; }

  /* RSVP */
  .rsvp-section { margin-bottom:16px; }
  .rsvp-buttons { display:flex; gap:8px; margin-bottom:12px; }
  .rsvp-btn {
    flex:1; padding:10px; border-radius:10px; border:2px solid transparent;
    cursor:pointer; font-size:13px; font-weight:700; transition:0.2s;
    text-align:center; background:rgba(50,20,80,0.4);
  }
  .rsvp-btn:hover { transform:translateY(-1px); }
  .rsvp-btn.going { color:var(--going); border-color:rgba(16,185,129,0.3); }
  .rsvp-btn.going.active { background:var(--going); color:#fff; border-color:var(--going); box-shadow:0 4px 15px rgba(16,185,129,0.3); }
  .rsvp-btn.maybe { color:var(--maybe); border-color:rgba(245,158,11,0.3); }
  .rsvp-btn.maybe.active { background:var(--maybe); color:#fff; border-color:var(--maybe); box-shadow:0 4px 15px rgba(245,158,11,0.3); }
  .rsvp-btn.cant { color:var(--cant); border-color:rgba(239,68,68,0.3); }
  .rsvp-btn.cant.active { background:var(--cant); color:#fff; border-color:var(--cant); box-shadow:0 4px 15px rgba(239,68,68,0.3); }

  .rsvp-summary { display:flex; flex-direction:column; gap:8px; }
  .rsvp-group { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .rsvp-group-label {
    font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px;
    padding:3px 10px; border-radius:8px; min-width:60px; text-align:center;
  }
  .rsvp-group-label.going-label { background:rgba(16,185,129,0.15); color:var(--going); }
  .rsvp-group-label.maybe-label { background:rgba(245,158,11,0.15); color:var(--maybe); }
  .rsvp-group-label.cant-label { background:rgba(239,68,68,0.15); color:var(--cant); }
  .rsvp-group-label.pending-label { background:rgba(167,139,218,0.15); color:var(--text2); }
  .rsvp-person {
    display:flex; align-items:center; gap:4px; padding:3px 10px; border-radius:20px;
    font-size:12px; background:rgba(50,20,80,0.5);
  }
  .rsvp-person .rp-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

  .color-options { display:flex; gap:8px; }
  .color-opt {
    width:28px; height:28px; border-radius:50%; cursor:pointer; border:2px solid transparent; transition:0.2s;
  }
  .color-opt:hover, .color-opt.selected { border-color:#fff; transform:scale(1.15); }

  /* Scrollbar */
  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:rgba(168,85,247,0.3); border-radius:3px; }

  /* Mobile */
  @media(max-width:768px) {
    .menu-btn { display:flex; }
    .sidebar {
      position:fixed; top:0; left:0; bottom:0; width:300px; z-index:600;
      transform:translateX(-100%); transition:transform 0.3s cubic-bezier(0.16,1,0.3,1);
      background:rgba(15,5,30,0.95); backdrop-filter:blur(20px);
    }
    .sidebar.open { transform:translateX(0); }
    .sidebar-close { display:block; }
    .cal-day { min-height:65px; padding:5px; }
    .cal-day .day-num { font-size:12px; }
    .cal-event { font-size:9px; padding:2px 4px; }
    header { padding:12px 16px; }
    .main { padding:16px; }
    .cal-header h2 { font-size:20px; }
    .logo h1 { font-size:18px; }
    .logo-icon { width:36px; height:36px; font-size:17px; }
  }
  @media(max-width:420px) {
    .cal-day { min-height:55px; }
    .cal-day-name { font-size:10px; }
    .user-select { padding:6px 10px; font-size:12px; max-width:100px; }
  }
</style>
</head>
<body>

<div id="toast-container"></div>

<header>
  <div class="header-left">
    <button class="menu-btn" id="menuBtn" onclick="toggleSidebar()">‚ò∞</button>
    <div class="logo">
      <div class="logo-icon">üìÖ</div>
      <h1>Connect Friends</h1>
    </div>
  </div>
  <div class="user-area">
    <select class="user-select" id="currentUser"></select>
    <button class="notification-bell" id="bellBtn" onclick="toggleNotifPanel()">
      üîî<span class="badge" id="notifBadge" style="display:none">0</span>
    </button>
  </div>
</header>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="app">
  <div class="sidebar" id="sidebar">
    <button class="sidebar-close" onclick="closeSidebar()">‚úï</button>
    <div>
      <div class="section-title">Members</div>
      <div class="member-list" id="memberList"></div>
      <div class="add-member-input">
        <input type="text" id="newMemberName" placeholder="Add member..." onkeydown="if(event.key==='Enter')addMember()">
        <button onclick="addMember()">+</button>
      </div>
    </div>
    <div>
      <div class="section-title">Upcoming Together</div>
      <div id="upcomingEvents"></div>
    </div>
  </div>

  <div class="main">
    <div class="cal-header">
      <h2 id="calTitle"></h2>
      <div class="cal-nav">
        <button onclick="changeMonth(-1)">‚óÄ</button>
        <button onclick="goToday()">‚óè</button>
        <button onclick="changeMonth(1)">‚ñ∂</button>
      </div>
    </div>
    <div class="cal-grid" id="calGrid"></div>
  </div>
</div>

<!-- Add/Edit Event Modal -->
<div class="modal-overlay" id="eventModal">
  <div class="modal">
    <h3 id="modalTitle">New Event</h3>
    <div class="form-group">
      <label>Event Title</label>
      <input type="text" id="evTitle" placeholder="e.g. Team Standup">
    </div>
    <div class="form-group">
      <label>Date</label>
      <input type="date" id="evDate">
    </div>
    <div class="form-group" style="display:flex;gap:10px">
      <div style="flex:1"><label>Start Time</label><input type="time" id="evStart" value="09:00"></div>
      <div style="flex:1"><label>End Time</label><input type="time" id="evEnd" value="10:00"></div>
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea id="evDesc" placeholder="Optional details..."></textarea>
    </div>
    <div class="form-group">
      <label>People</label>
      <div class="people-checkboxes" id="evPeople"></div>
    </div>
    <div class="form-group">
      <label>Color</label>
      <div class="color-options" id="evColor"></div>
    </div>
    <div class="form-group">
      <label>Reminder</label>
      <div class="reminder-options">
        <label><input type="radio" name="reminder" value="0" checked>None</label>
        <label><input type="radio" name="reminder" value="5">5 min</label>
        <label><input type="radio" name="reminder" value="15">15 min</label>
        <label><input type="radio" name="reminder" value="30">30 min</label>
        <label><input type="radio" name="reminder" value="60">1 hour</label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-danger" id="deleteBtn" onclick="deleteEvent()" style="display:none">üóë</button>
      <button class="btn btn-primary" onclick="saveEvent()">Save Event</button>
    </div>
  </div>
</div>

<!-- Event Detail Modal -->
<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <div class="event-detail-header">
      <div class="event-color-dot" id="detColor"></div>
      <h3 id="detTitle" style="margin-bottom:0"></h3>
    </div>
    <div class="event-detail-time" id="detTime"></div>
    <div class="event-detail-desc" id="detDesc"></div>
    <div class="event-detail-reminder" id="detReminder"></div>

    <div class="rsvp-section">
      <div class="section-title" style="margin-bottom:10px">Your RSVP</div>
      <div class="rsvp-buttons" id="rsvpButtons">
        <div class="rsvp-btn going" onclick="setRSVP('going')">‚úì Going</div>
        <div class="rsvp-btn maybe" onclick="setRSVP('maybe')">? Maybe</div>
        <div class="rsvp-btn cant" onclick="setRSVP('cant')">‚úï Can't</div>
      </div>
      <div class="section-title" style="margin-bottom:8px">Responses</div>
      <div class="rsvp-summary" id="rsvpSummary"></div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeDetail()">Close</button>
      <button class="btn btn-primary" onclick="editFromDetail()">Edit</button>
    </div>
  </div>
</div>

<script>
const COLORS = ['#a855f7','#ef4444','#10b981','#f59e0b','#3b82f6','#ec4899','#06b6d4','#8b5cf6'];
const MEMBER_COLORS = ['#a855f7','#3b82f6','#10b981','#f59e0b','#ef4444','#ec4899','#06b6d4','#8b5cf6'];

let members = [
  {id:1, name:'Alice', color:MEMBER_COLORS[0]},
  {id:2, name:'Bob', color:MEMBER_COLORS[1]},
  {id:3, name:'Carol', color:MEMBER_COLORS[2]},
];
let nextMemberId = 4;
let currentUserId = 1;

const today = new Date();
const y = today.getFullYear(), m = today.getMonth(), d = today.getDate();

let events = [
  {id:1, title:'Team Standup', date:fmt(y,m,d), start:'09:00', end:'09:30', desc:'Daily sync', people:[1,2,3], color:'#a855f7', reminder:15, rsvp:{1:'going',2:'going',3:'maybe'}},
  {id:2, title:'Design Review', date:fmt(y,m,d+1), start:'14:00', end:'15:00', desc:'Review new mockups', people:[1,3], color:'#3b82f6', reminder:30, rsvp:{1:'going',3:'going'}},
  {id:3, title:'Lunch Together', date:fmt(y,m,d+2), start:'12:00', end:'13:00', desc:'Team lunch at the new place', people:[1,2], color:'#10b981', reminder:60, rsvp:{1:'maybe',2:'going'}},
  {id:4, title:'Sprint Planning', date:fmt(y,m,d+3), start:'10:00', end:'11:30', desc:'Plan next sprint', people:[1,2,3], color:'#f59e0b', reminder:15, rsvp:{1:'going',2:'cant',3:'going'}},
];
let nextEventId = 5;
let editingEventId = null;
let viewMonth = m, viewYear = y;
let selectedColor = COLORS[0];
let currentDetailEventId = null;

function fmt(y,m,d) { return new Date(y,m,d).toISOString().split('T')[0]; }

// Sidebar toggle
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('active');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('active');
}

function showToast(title, msg, isReminder) {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast' + (isReminder ? ' reminder' : '');
  t.innerHTML = `<span class="toast-icon">${isReminder?'‚è∞':'üîî'}</span><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div></div>`;
  c.appendChild(t);
  setTimeout(() => t.remove(), 5000);
}

function renderMembers() {
  const ml = document.getElementById('memberList');
  const us = document.getElementById('currentUser');
  ml.innerHTML = members.map(m => `
    <div class="member">
      <div class="member-avatar" style="background:${m.color}">${m.name[0]}</div>
      <div><div class="member-name">${m.name}</div><div class="member-status">${m.id===currentUserId?'You':'Member'}</div></div>
    </div>`).join('');
  us.innerHTML = members.map(m => `<option value="${m.id}" ${m.id===currentUserId?'selected':''}>${m.name}</option>`).join('');
  us.onchange = e => { currentUserId = +e.target.value; renderAll(); };
}

function addMember() {
  const inp = document.getElementById('newMemberName');
  const n = inp.value.trim();
  if(!n) return;
  members.push({id:nextMemberId++, name:n, color:MEMBER_COLORS[(members.length)%MEMBER_COLORS.length]});
  inp.value = '';
  renderMembers();
  showToast('Member Added', `${n} joined the calendar!`);
}

function renderUpcoming() {
  const now = new Date();
  const upcoming = events
    .filter(e => e.people.length > 1 && e.people.includes(currentUserId))
    .filter(e => new Date(e.date+'T'+e.start) >= new Date(now.toDateString()))
    .sort((a,b) => new Date(a.date+'T'+a.start) - new Date(b.date+'T'+b.start))
    .slice(0,5);
  document.getElementById('upcomingEvents').innerHTML = upcoming.length ? upcoming.map(e => {
    const ppl = e.people.map(pid => members.find(m=>m.id===pid)?.name).filter(Boolean);
    const goingC = e.people.filter(pid => e.rsvp[pid]==='going').length;
    const maybeC = e.people.filter(pid => e.rsvp[pid]==='maybe').length;
    const cantC = e.people.filter(pid => e.rsvp[pid]==='cant').length;
    const dt = new Date(e.date+'T'+e.start);
    return `<div class="upcoming-event" onclick="showDetail(${e.id})" style="border-left-color:${e.color}">
      <div class="ue-title">${e.title}</div>
      <div class="ue-time">${dt.toLocaleDateString('en',{weekday:'short',month:'short',day:'numeric'})} ¬∑ ${e.start} - ${e.end}</div>
      <div class="ue-people">üë• ${ppl.join(', ')}</div>
      <div class="ue-rsvp">
        ${goingC?`<span class="ue-rsvp-tag" style="background:rgba(16,185,129,0.15);color:var(--going)">‚úì${goingC}</span>`:''}
        ${maybeC?`<span class="ue-rsvp-tag" style="background:rgba(245,158,11,0.15);color:var(--maybe)">?${maybeC}</span>`:''}
        ${cantC?`<span class="ue-rsvp-tag" style="background:rgba(239,68,68,0.15);color:var(--cant)">‚úï${cantC}</span>`:''}
      </div>
    </div>`;
  }).join('') : '<p style="font-size:13px;color:var(--text2)">No upcoming group events</p>';
}

function renderCalendar() {
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calTitle').textContent = `${months[viewMonth]} ${viewYear}`;
  const grid = document.getElementById('calGrid');
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let html = days.map(d => `<div class="cal-day-name">${d}</div>`).join('');
  const first = new Date(viewYear, viewMonth, 1);
  const last = new Date(viewYear, viewMonth+1, 0);
  const startDay = first.getDay();
  const prevLast = new Date(viewYear, viewMonth, 0).getDate();

  for(let i = startDay-1; i >= 0; i--) {
    html += calDayHTML(prevLast-i, fmt(viewYear, viewMonth-1, prevLast-i), true);
  }
  for(let i = 1; i <= last.getDate(); i++) {
    const dt = fmt(viewYear, viewMonth, i);
    const isToday = i===today.getDate() && viewMonth===today.getMonth() && viewYear===today.getFullYear();
    html += calDayHTML(i, dt, false, isToday);
  }
  const totalCells = startDay + last.getDate();
  const remaining = (7 - totalCells % 7) % 7;
  for(let i = 1; i <= remaining; i++) {
    html += calDayHTML(i, fmt(viewYear, viewMonth+1, i), true);
  }
  grid.innerHTML = html;
}

function calDayHTML(dayNum, dateStr, otherMonth, isToday) {
  const dayEvents = events.filter(e => e.date === dateStr).slice(0,3);
  const cls = ['cal-day'];
  if(otherMonth) cls.push('other-month');
  if(isToday) cls.push('today');
  return `<div class="${cls.join(' ')}" onclick="openModal('${dateStr}')">
    <div class="day-num">${dayNum}</div>
    ${dayEvents.map(e => {
      const myRsvp = e.rsvp[currentUserId];
      const rsvpDot = myRsvp==='going'?'‚úì':myRsvp==='maybe'?'?':myRsvp==='cant'?'‚úï':'';
      return `<div class="cal-event" style="background:${e.color}" onclick="event.stopPropagation();showDetail(${e.id})" title="${e.title}">${rsvpDot?rsvpDot+' ':''}${e.title}</div>`;
    }).join('')}
    ${events.filter(e=>e.date===dateStr).length>3?`<div style="font-size:10px;color:var(--text2)">+${events.filter(e=>e.date===dateStr).length-3} more</div>`:''}
  </div>`;
}

function changeMonth(delta) { viewMonth+=delta; if(viewMonth>11){viewMonth=0;viewYear++} if(viewMonth<0){viewMonth=11;viewYear--} renderCalendar(); }
function goToday() { viewMonth=today.getMonth(); viewYear=today.getFullYear(); renderCalendar(); }

function openModal(dateStr) {
  editingEventId = null;
  document.getElementById('modalTitle').textContent = 'New Event';
  document.getElementById('deleteBtn').style.display = 'none';
  document.getElementById('evTitle').value = '';
  document.getElementById('evDate').value = dateStr;
  document.getElementById('evStart').value = '09:00';
  document.getElementById('evEnd').value = '10:00';
  document.getElementById('evDesc').value = '';
  document.querySelector('input[name="reminder"][value="0"]').checked = true;
  selectedColor = COLORS[0];
  renderColorPicker();
  renderPeopleCheckboxes([currentUserId]);
  document.getElementById('eventModal').classList.add('active');
}

function renderColorPicker() {
  document.getElementById('evColor').innerHTML = COLORS.map(c =>
    `<div class="color-opt ${c===selectedColor?'selected':''}" style="background:${c}" onclick="selectedColor='${c}';renderColorPicker()"></div>`
  ).join('');
}

function renderPeopleCheckboxes(selected) {
  document.getElementById('evPeople').innerHTML = members.map(m =>
    `<label><input type="checkbox" value="${m.id}" ${selected.includes(m.id)?'checked':''}>${m.name}</label>`
  ).join('');
}

function closeModal() { document.getElementById('eventModal').classList.remove('active'); }

function saveEvent() {
  const title = document.getElementById('evTitle').value.trim();
  const date = document.getElementById('evDate').value;
  const start = document.getElementById('evStart').value;
  const end = document.getElementById('evEnd').value;
  const desc = document.getElementById('evDesc').value.trim();
  const people = [...document.querySelectorAll('#evPeople input:checked')].map(i=>+i.value);
  const reminder = +document.querySelector('input[name="reminder"]:checked').value;

  if(!title || !date) { showToast('Error','Please fill in title and date'); return; }
  if(people.length === 0) { showToast('Error','Select at least one person'); return; }

  if(editingEventId) {
    const ev = events.find(e=>e.id===editingEventId);
    const newRsvp = {...ev.rsvp};
    people.forEach(pid => { if(!newRsvp[pid]) newRsvp[pid] = null; });
    Object.keys(newRsvp).forEach(pid => { if(!people.includes(+pid)) delete newRsvp[pid]; });
    Object.assign(ev, {title,date,start,end,desc,people,color:selectedColor,reminder,rsvp:newRsvp});
    showToast('Event Updated', `"${title}" has been updated`);
  } else {
    const rsvp = {};
    people.forEach(pid => { rsvp[pid] = pid===currentUserId ? 'going' : null; });
    events.push({id:nextEventId++, title, date, start, end, desc, people, color:selectedColor, reminder, rsvp});
    if(people.length > 1) {
      const names = people.map(pid=>members.find(m=>m.id===pid)?.name).filter(Boolean).join(', ');
      showToast('Group Event Created!', `"${title}" with ${names} ‚Äî awaiting RSVPs`);
    } else {
      showToast('Event Created', `"${title}" added to calendar`);
    }
  }
  closeModal();
  renderAll();
  scheduleReminders();
}

function deleteEvent() {
  if(!editingEventId) return;
  const ev = events.find(e=>e.id===editingEventId);
  events = events.filter(e=>e.id!==editingEventId);
  showToast('Event Deleted', `"${ev.title}" removed`);
  closeModal();
  renderAll();
}

function showDetail(id) {
  const ev = events.find(e=>e.id===id);
  if(!ev) return;
  currentDetailEventId = id;
  document.getElementById('detColor').style.background = ev.color;
  document.getElementById('detTitle').textContent = ev.title;
  document.getElementById('detTime').textContent = `üìÖ ${new Date(ev.date).toLocaleDateString('en',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}  ¬∑  üïê ${ev.start} - ${ev.end}`;
  document.getElementById('detDesc').textContent = ev.desc || 'No description';
  document.getElementById('detReminder').textContent = ev.reminder ? `‚è∞ Reminder: ${ev.reminder} min before` : '';

  const myRsvp = ev.rsvp[currentUserId];
  const isInvited = ev.people.includes(currentUserId);
  const btns = document.getElementById('rsvpButtons');
  if(isInvited) {
    btns.style.display = 'flex';
    btns.querySelectorAll('.rsvp-btn').forEach(b => b.classList.remove('active'));
    if(myRsvp) {
      const activeBtn = btns.querySelector(`.rsvp-btn.${myRsvp}`);
      if(activeBtn) activeBtn.classList.add('active');
    }
  } else {
    btns.style.display = 'none';
  }
  renderRSVPSummary(ev);
  document.getElementById('detailModal').classList.add('active');
}

function renderRSVPSummary(ev) {
  const groups = {going:[], maybe:[], cant:[], pending:[]};
  ev.people.forEach(pid => {
    const m = members.find(mm=>mm.id===pid);
    if(!m) return;
    const s = ev.rsvp[pid];
    (groups[s] || groups.pending).push(m);
  });
  let html = '';
  const renderGroup = (label, cls, arr) => {
    if(!arr.length) return '';
    return `<div class="rsvp-group">
      <span class="rsvp-group-label ${cls}">${label} (${arr.length})</span>
      ${arr.map(m => `<span class="rsvp-person"><span class="rp-dot" style="background:${m.color}"></span>${m.name}</span>`).join('')}
    </div>`;
  };
  html += renderGroup('Going', 'going-label', groups.going);
  html += renderGroup('Maybe', 'maybe-label', groups.maybe);
  html += renderGroup("Can't", 'cant-label', groups.cant);
  html += renderGroup('Pending', 'pending-label', groups.pending);
  document.getElementById('rsvpSummary').innerHTML = html;
}

function setRSVP(status) {
  if(!currentDetailEventId) return;
  const ev = events.find(e=>e.id===currentDetailEventId);
  if(!ev || !ev.people.includes(currentUserId)) return;
  ev.rsvp[currentUserId] = status;
  document.querySelectorAll('#rsvpButtons .rsvp-btn').forEach(b => b.classList.remove('active'));
  const activeBtn = document.querySelector(`#rsvpButtons .rsvp-btn.${status}`);
  if(activeBtn) activeBtn.classList.add('active');
  renderRSVPSummary(ev);
  renderCalendar();
  renderUpcoming();
  const userName = members.find(m=>m.id===currentUserId)?.name;
  const statusText = status==='going'?'Going ‚úì':status==='maybe'?'Maybe ?':"Can't ‚úï";
  showToast('RSVP Updated', `${userName} ‚Üí ${statusText} for "${ev.title}"`);
}

function closeDetail() { document.getElementById('detailModal').classList.remove('active'); currentDetailEventId = null; }

function editFromDetail() {
  const id = currentDetailEventId;
  closeDetail();
  const ev = events.find(e=>e.id===id);
  if(!ev) return;
  editingEventId = id;
  document.getElementById('modalTitle').textContent = 'Edit Event';
  document.getElementById('deleteBtn').style.display = '';
  document.getElementById('evTitle').value = ev.title;
  document.getElementById('evDate').value = ev.date;
  document.getElementById('evStart').value = ev.start;
  document.getElementById('evEnd').value = ev.end;
  document.getElementById('evDesc').value = ev.desc;
  selectedColor = ev.color;
  renderColorPicker();
  renderPeopleCheckboxes(ev.people);
  const rInput = document.querySelector(`input[name="reminder"][value="${ev.reminder}"]`);
  if(rInput) rInput.checked = true;
  document.getElementById('eventModal').classList.add('active');
}

function toggleNotifPanel() {
  const pendingRsvp = events.filter(e => e.people.includes(currentUserId) && !e.rsvp[currentUserId]);
  pendingRsvp.forEach(e => {
    showToast('RSVP Needed', `You haven't responded to "${e.title}"`, true);
  });
  const upcoming = events
    .filter(e => e.people.length > 1 && e.people.includes(currentUserId))
    .sort((a,b) => new Date(a.date+'T'+a.start) - new Date(b.date+'T'+b.start))
    .slice(0,3);
  if(upcoming.length && !pendingRsvp.length) {
    upcoming.forEach(e => {
      const ppl = e.people.filter(p=>p!==currentUserId).map(pid=>members.find(m=>m.id===pid)?.name).join(', ');
      const goingC = e.people.filter(pid => e.rsvp[pid]==='going').length;
      showToast(`${e.title}`, `${e.date} at ${e.start} with ${ppl} ¬∑ ${goingC} going`, true);
    });
  }
  if(!upcoming.length && !pendingRsvp.length) {
    showToast('All Clear', 'No pending RSVPs or upcoming group events');
  }
}

let reminderTimers = [];
function scheduleReminders() {
  reminderTimers.forEach(t => clearTimeout(t));
  reminderTimers = [];
  const now = new Date();
  events.forEach(ev => {
    if(!ev.reminder || !ev.people.includes(currentUserId) || ev.people.length < 2) return;
    if(ev.rsvp[currentUserId]==='cant') return;
    const evTime = new Date(ev.date+'T'+ev.start);
    const reminderTime = new Date(evTime.getTime() - ev.reminder * 60000);
    const diff = reminderTime - now;
    if(diff > 0 && diff < 86400000) {
      const t = setTimeout(() => {
        const ppl = ev.people.filter(p=>p!==currentUserId).map(pid=>members.find(m=>m.id===pid)?.name).join(', ');
        showToast(`‚è∞ ${ev.title}`, `Starting in ${ev.reminder} min with ${ppl}`, true);
        if('Notification' in window && Notification.permission === 'granted') {
          new Notification(`Connect Friends: ${ev.title}`, {body:`Starting in ${ev.reminder} min with ${ppl}`});
        }
      }, diff);
      reminderTimers.push(t);
    }
  });
}

if('Notification' in window && Notification.permission === 'default') {
  Notification.requestPermission();
}

function renderAll() {
  renderMembers();
  renderCalendar();
  renderUpcoming();
}

renderAll();
scheduleReminders();

setTimeout(() => {
  showToast('Welcome to Connect Friends! üëã', 'Tap ‚ò∞ to open the sidebar on mobile');
}, 500);
</script>
</body>
</html>
