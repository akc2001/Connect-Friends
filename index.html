<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Connect Friends</title>
<style>
  :root {
    --royal: #43215F;
    --royal-light: #5a3478;
    --royal-dark: #321848;
    --pearl: #FFFFFF;
    --charcoal: #2E2A35;
    --gold: #E6D6A8;
    --gold-dark: #c9b87a;
    --gold-light: #f0e6c4;
    --surface: #FFFFFF;
    --surface2: #F7F4F9;
    --surface3: #EDE8F2;
    --text: #2E2A35;
    --text2: #6B6273;
    --danger: #C0392B;
    --success: #27AE60;
    --warning: #D4A017;
    --maybe: #D4A017;
    --cant: #C0392B;
    --going: #27AE60;
    --border: rgba(67,33,95,0.15);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family:'Segoe UI',system-ui,sans-serif; color:var(--text); min-height:100vh;
    background: linear-gradient(160deg, #f7f4f9 0%, #ede8f2 40%, #e6d6a8 100%);
    background-attachment: fixed;
  }

  #toast-container { position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px; }
  .toast {
    background: linear-gradient(135deg, var(--royal), var(--royal-dark));
    color:var(--pearl); padding:14px 20px; border-radius:12px; min-width:280px; max-width:340px;
    box-shadow: 0 8px 32px rgba(67,33,95,0.3);
    animation: slideIn 0.4s cubic-bezier(0.16,1,0.3,1), fadeOut 0.4s 4.6s forwards;
    display:flex; align-items:flex-start; gap:12px;
  }
  .toast.reminder { background: linear-gradient(135deg, var(--gold-dark), var(--warning)); color:var(--charcoal); }
  .toast-icon { font-size:20px; margin-top:2px; }
  .toast-content { flex:1; }
  .toast-title { font-weight:700; font-size:14px; }
  .toast-msg { font-size:12px; opacity:0.9; margin-top:2px; }
  @keyframes slideIn { from{transform:translateX(120%);opacity:0} to{transform:translateX(0);opacity:1} }
  @keyframes fadeOut { to{transform:translateX(120%);opacity:0} }

  .welcome-screen { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
  .welcome-card {
    background:var(--pearl); border-radius:24px; padding:40px; max-width:440px; width:100%;
    box-shadow: 0 20px 60px rgba(67,33,95,0.15); text-align:center;
  }
  .welcome-logo { font-size:48px; margin-bottom:12px; }
  .welcome-card h1 { font-size:28px; color:var(--royal); margin-bottom:6px; font-weight:800; }
  .welcome-card p { color:var(--text2); font-size:14px; margin-bottom:28px; line-height:1.5; }
  .welcome-input {
    width:100%; background:var(--surface2); border:1px solid var(--border); color:var(--charcoal);
    padding:12px 16px; border-radius:12px; font-size:15px; font-family:inherit; margin-bottom:12px;
  }
  .welcome-input:focus { outline:none; border-color:var(--royal); box-shadow:0 0 8px rgba(67,33,95,0.15); }
  .welcome-input::placeholder { color:var(--text2); }
  .welcome-btn {
    width:100%; padding:13px; border-radius:12px; border:none; font-size:15px; font-weight:700;
    cursor:pointer; transition:0.2s; margin-bottom:8px;
  }
  .welcome-btn-primary { background:var(--royal); color:var(--pearl); }
  .welcome-btn-primary:hover { background:var(--royal-light); transform:translateY(-1px); box-shadow:0 4px 15px rgba(67,33,95,0.3); }
  .welcome-btn-gold { background:var(--gold); color:var(--charcoal); }
  .welcome-btn-gold:hover { background:var(--gold-dark); transform:translateY(-1px); }
  .welcome-code {
    display:inline-block; background:var(--surface2); border:2px dashed var(--gold-dark);
    padding:10px 24px; border-radius:12px; font-size:22px; font-weight:800; letter-spacing:4px;
    color:var(--royal); margin:12px 0; font-family:monospace; user-select:all;
  }
  .welcome-small { font-size:12px; color:var(--text2); margin-top:8px; }
  .welcome-back-btn { background:none; border:none; color:var(--royal); cursor:pointer; font-size:13px; margin-top:12px; text-decoration:underline; }
  .welcome-error { color:var(--danger); font-size:13px; margin-bottom:8px; display:none; }

  header {
    background: var(--royal); border-bottom:2px solid var(--gold);
    padding:16px 24px; display:flex; align-items:center; justify-content:space-between;
    box-shadow: 0 4px 20px rgba(67,33,95,0.2);
  }
  .header-left { display:flex; align-items:center; gap:12px; }
  .menu-btn {
    display:none; background:var(--royal-light); border:1px solid rgba(255,255,255,0.2); color:var(--pearl);
    width:40px; height:40px; border-radius:10px; cursor:pointer; font-size:20px;
    align-items:center; justify-content:center; transition:0.2s; flex-shrink:0;
  }
  .menu-btn:hover { background:var(--gold); color:var(--charcoal); }
  .logo { display:flex; align-items:center; gap:12px; }
  .logo-icon {
    width:42px; height:42px; background: var(--gold);
    border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px;
    box-shadow: 0 4px 15px rgba(230,214,168,0.3);
  }
  .logo h1 { font-size:22px; font-weight:700; color:var(--pearl); letter-spacing:0.5px; }
  .user-area { display:flex; align-items:center; gap:12px; }
  .user-select {
    background:var(--royal-light); color:var(--pearl); border:1px solid rgba(255,255,255,0.2);
    padding:8px 14px; border-radius:10px; font-size:14px; cursor:pointer;
  }
  .user-select:focus { outline:none; border-color:var(--gold); }
  .user-select option { background:var(--royal); color:var(--pearl); }
  .header-code {
    background:rgba(230,214,168,0.2); color:var(--gold); border:1px solid rgba(230,214,168,0.3);
    padding:6px 12px; border-radius:8px; font-size:12px; font-weight:700; letter-spacing:2px;
    font-family:monospace; cursor:pointer; transition:0.2s;
  }
  .header-code:hover { background:rgba(230,214,168,0.3); }
  .notification-bell {
    position:relative; background:var(--royal-light); border:1px solid rgba(255,255,255,0.2);
    color:var(--pearl); width:40px; height:40px; border-radius:10px; cursor:pointer; font-size:18px;
    display:flex; align-items:center; justify-content:center; transition:0.2s; flex-shrink:0;
  }
  .notification-bell:hover { background:var(--gold); color:var(--charcoal); }
  .leave-btn {
    background:rgba(192,57,43,0.15); color:#e74c3c; border:1px solid rgba(192,57,43,0.3);
    padding:8px 12px; border-radius:10px; font-size:12px; font-weight:600; cursor:pointer; transition:0.2s;
  }
  .leave-btn:hover { background:rgba(192,57,43,0.25); }

  .app { display:flex; height:calc(100vh - 75px); }
  .sidebar {
    width:290px; background:var(--pearl); border-right:1px solid var(--border);
    padding:20px; display:flex; flex-direction:column; gap:20px; overflow-y:auto; flex-shrink:0;
  }
  .main { flex:1; padding:24px; overflow-y:auto; }
  .sidebar-overlay { display:none; position:fixed; inset:0; background:rgba(46,42,53,0.4); z-index:500; backdrop-filter:blur(4px); }
  .sidebar-overlay.active { display:block; }

  .section-title { font-size:11px; text-transform:uppercase; letter-spacing:1.5px; color:var(--royal); margin-bottom:8px; font-weight:700; }
  .member-list { display:flex; flex-direction:column; gap:6px; }
  .member { display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; transition:0.2s; }
  .member:hover { background:var(--surface3); }
  .member-avatar {
    width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center;
    font-size:13px; font-weight:700; color:#fff; flex-shrink:0;
  }
  .member-name { font-size:14px; font-weight:500; color:var(--charcoal); }
  .member-status { font-size:11px; color:var(--text2); }

  .add-member-input { display:flex; gap:6px; margin-top:4px; }
  .add-member-input input {
    flex:1; background:var(--surface2); border:1px solid var(--border); color:var(--charcoal);
    padding:8px 12px; border-radius:8px; font-size:13px;
  }
  .add-member-input input:focus { outline:none; border-color:var(--royal); }
  .add-member-input button {
    background:var(--royal); color:var(--pearl); border:none; padding:8px 12px; border-radius:8px;
    cursor:pointer; font-weight:600; font-size:13px; transition:0.2s;
  }
  .add-member-input button:hover { background:var(--royal-light); }
  .sidebar-close { display:none; background:none; border:none; color:var(--charcoal); font-size:24px; cursor:pointer; align-self:flex-end; padding:4px 8px; margin:-8px -8px 0 0; }

  .share-box { background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:12px; text-align:center; }
  .share-box .share-label { font-size:11px; color:var(--text2); margin-bottom:6px; }
  .share-box .share-code { font-size:20px; font-weight:800; letter-spacing:3px; color:var(--royal); font-family:monospace; cursor:pointer; }
  .share-box .share-hint { font-size:10px; color:var(--text2); margin-top:4px; }

  .upcoming-event {
    padding:10px 12px; background:var(--surface2); border-radius:10px;
    border-left:3px solid var(--royal); margin-bottom:8px; cursor:pointer; transition:0.2s;
  }
  .upcoming-event:hover { transform:translateX(4px); background:var(--surface3); }
  .upcoming-event .ue-title { font-size:13px; font-weight:600; color:var(--charcoal); }
  .upcoming-event .ue-time { font-size:11px; color:var(--text2); margin-top:2px; }
  .upcoming-event .ue-people { font-size:11px; color:var(--royal); margin-top:4px; }
  .upcoming-event .ue-rsvp { font-size:10px; margin-top:4px; display:flex; gap:8px; }
  .ue-rsvp-tag { padding:2px 8px; border-radius:10px; font-weight:600; }

  .cal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
  .cal-header h2 { font-size:26px; font-weight:700; color:var(--royal); }
  .cal-nav { display:flex; gap:8px; }
  .cal-nav button {
    background:var(--pearl); border:1px solid var(--border); color:var(--royal);
    width:38px; height:38px; border-radius:10px; cursor:pointer; font-size:16px;
    display:flex; align-items:center; justify-content:center; transition:0.2s;
  }
  .cal-nav button:hover { background:var(--royal); color:var(--pearl); border-color:var(--royal); }

  .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
  .cal-day-name { text-align:center; font-size:12px; color:var(--royal); padding:8px 0; font-weight:700; text-transform:uppercase; letter-spacing:1px; }
  .cal-day {
    min-height:100px; background:var(--pearl); border:1px solid var(--border); border-radius:12px;
    padding:8px; cursor:pointer; transition:0.2s; position:relative;
    box-shadow: 0 1px 3px rgba(67,33,95,0.05);
  }
  .cal-day:hover { border-color:var(--royal); transform:translateY(-2px); box-shadow:0 4px 20px rgba(67,33,95,0.12); }
  .cal-day.today { border-color:var(--gold-dark); background:linear-gradient(135deg, #faf6eb, #f7f4f9); box-shadow:0 0 15px rgba(230,214,168,0.3); }
  .cal-day.other-month { opacity:0.35; }
  .cal-day .day-num { font-size:13px; font-weight:600; margin-bottom:4px; color:var(--charcoal); }
  .cal-day.today .day-num { color:var(--royal); font-weight:700; }
  .cal-event {
    font-size:10px; padding:3px 6px; border-radius:6px; margin-bottom:3px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#fff; font-weight:500; cursor:pointer;
  }
  .cal-event:hover { filter:brightness(1.1); }

  .modal-overlay {
    display:none; position:fixed; inset:0; background:rgba(46,42,53,0.5); z-index:1000;
    align-items:center; justify-content:center; backdrop-filter:blur(4px);
  }
  .modal-overlay.active { display:flex; }
  .modal {
    background:var(--pearl); border:1px solid var(--border); border-radius:20px;
    padding:28px; width:460px; max-width:92vw; max-height:90vh; overflow-y:auto;
    box-shadow: 0 20px 60px rgba(67,33,95,0.2);
    animation: modalIn 0.3s cubic-bezier(0.16,1,0.3,1);
  }
  @keyframes modalIn { from{transform:scale(0.9) translateY(20px);opacity:0} to{transform:scale(1) translateY(0);opacity:1} }
  .modal h3 { font-size:20px; margin-bottom:20px; font-weight:700; color:var(--royal); }
  .form-group { margin-bottom:16px; }
  .form-group label { display:block; font-size:12px; color:var(--royal); margin-bottom:6px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
  .form-group input, .form-group select, .form-group textarea {
    width:100%; background:var(--surface2); border:1px solid var(--border); color:var(--charcoal);
    padding:10px 14px; border-radius:10px; font-size:14px; font-family:inherit;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline:none; border-color:var(--royal); box-shadow:0 0 8px rgba(67,33,95,0.15); }
  .form-group textarea { resize:vertical; min-height:60px; }

  .people-checkboxes { display:flex; flex-wrap:wrap; gap:8px; }
  .people-checkboxes label {
    display:flex; align-items:center; gap:6px; padding:6px 12px;
    background:var(--surface2); border:1px solid var(--border); border-radius:20px;
    cursor:pointer; font-size:13px; transition:0.2s; text-transform:none; letter-spacing:0; color:var(--charcoal);
  }
  .people-checkboxes label:has(input:checked) { background:var(--royal); border-color:var(--royal); color:var(--pearl); }
  .people-checkboxes label input { display:none; }

  .reminder-options { display:flex; flex-wrap:wrap; gap:6px; }
  .reminder-options label {
    padding:6px 12px; background:var(--surface2); border:1px solid var(--border);
    border-radius:20px; cursor:pointer; font-size:12px; transition:0.2s; text-transform:none; letter-spacing:0; color:var(--charcoal);
  }
  .reminder-options label:has(input:checked) { background:var(--gold); border-color:var(--gold-dark); color:var(--charcoal); font-weight:600; }
  .reminder-options label input { display:none; }

  .modal-actions { display:flex; gap:10px; margin-top:20px; }
  .btn { padding:10px 20px; border-radius:10px; border:none; font-size:14px; font-weight:600; cursor:pointer; transition:0.2s; flex:1; }
  .btn-primary { background:var(--royal); color:var(--pearl); }
  .btn-primary:hover { background:var(--royal-light); transform:translateY(-1px); box-shadow:0 4px 15px rgba(67,33,95,0.3); }
  .btn-secondary { background:var(--surface2); color:var(--charcoal); border:1px solid var(--border); }
  .btn-secondary:hover { background:var(--surface3); }
  .btn-danger { background:var(--danger); color:#fff; flex:0; padding:10px 16px; }

  .event-detail-header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
  .event-color-dot { width:14px; height:14px; border-radius:50%; flex-shrink:0; }
  .event-detail-time { color:var(--text2); font-size:14px; margin-bottom:12px; }
  .event-detail-desc { color:var(--text2); font-size:14px; margin-bottom:16px; line-height:1.5; }
  .event-detail-reminder { font-size:12px; color:var(--warning); margin-bottom:16px; }

  .rsvp-section { margin-bottom:16px; }
  .rsvp-buttons { display:flex; gap:8px; margin-bottom:12px; }
  .rsvp-btn {
    flex:1; padding:10px; border-radius:10px; border:2px solid transparent;
    cursor:pointer; font-size:13px; font-weight:700; transition:0.2s;
    text-align:center; background:var(--surface2);
  }
  .rsvp-btn:hover { transform:translateY(-1px); }
  .rsvp-btn.going { color:var(--going); border-color:rgba(39,174,96,0.25); }
  .rsvp-btn.going.active { background:var(--going); color:#fff; border-color:var(--going); }
  .rsvp-btn.maybe { color:var(--maybe); border-color:rgba(212,160,23,0.25); }
  .rsvp-btn.maybe.active { background:var(--gold); color:var(--charcoal); border-color:var(--gold-dark); }
  .rsvp-btn.cant { color:var(--cant); border-color:rgba(192,57,43,0.25); }
  .rsvp-btn.cant.active { background:var(--cant); color:#fff; border-color:var(--cant); }

  .rsvp-summary { display:flex; flex-direction:column; gap:8px; }
  .rsvp-group { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .rsvp-group-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; padding:3px 10px; border-radius:8px; min-width:60px; text-align:center; }
  .rsvp-group-label.going-label { background:rgba(39,174,96,0.1); color:var(--going); }
  .rsvp-group-label.maybe-label { background:rgba(230,214,168,0.4); color:var(--warning); }
  .rsvp-group-label.cant-label { background:rgba(192,57,43,0.1); color:var(--cant); }
  .rsvp-group-label.pending-label { background:var(--surface3); color:var(--text2); }
  .rsvp-person { display:flex; align-items:center; gap:4px; padding:3px 10px; border-radius:20px; font-size:12px; background:var(--surface2); color:var(--charcoal); }
  .rsvp-person .rp-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

  .color-options { display:flex; gap:8px; }
  .color-opt { width:28px; height:28px; border-radius:50%; cursor:pointer; border:3px solid transparent; transition:0.2s; }
  .color-opt:hover, .color-opt.selected { border-color:var(--royal); transform:scale(1.15); }

  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:rgba(67,33,95,0.2); border-radius:3px; }

  @media(max-width:768px) {
    .menu-btn { display:flex; }
    .sidebar {
      position:fixed; top:0; left:0; bottom:0; width:300px; z-index:600;
      transform:translateX(-100%); transition:transform 0.3s cubic-bezier(0.16,1,0.3,1);
      box-shadow: 4px 0 30px rgba(67,33,95,0.2);
    }
    .sidebar.open { transform:translateX(0); }
    .sidebar-close { display:block; }
    .cal-day { min-height:65px; padding:5px; }
    .cal-day .day-num { font-size:12px; }
    .cal-event { font-size:9px; padding:2px 4px; }
    header { padding:12px 16px; }
    .main { padding:16px; }
    .cal-header h2 { font-size:20px; }
    .logo h1 { font-size:18px; }
    .logo-icon { width:36px; height:36px; font-size:17px; }
    .header-code { display:none; }
  }
  @media(max-width:420px) {
    .cal-day { min-height:55px; }
    .cal-day-name { font-size:10px; }
    .user-select { padding:6px 10px; font-size:12px; max-width:100px; }
  }
</style>
</head>
<body>

<div id="toast-container"></div>

<div id="welcomeScreen" class="welcome-screen">
  <div class="welcome-card">
    <div class="welcome-logo">üìÖ</div>
    <h1>Connect Friends</h1>
    <p>Stay in sync with your friends.<br>Create a new code or join an existing one.</p>

    <div id="stepChoice">
      <input class="welcome-input" id="yourName" placeholder="Your name" maxlength="20">
      <input class="welcome-input" id="codeInput" placeholder="Enter a code" maxlength="10" style="text-align:center;font-size:20px;letter-spacing:3px;font-family:monospace;text-transform:uppercase">
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="welcome-btn welcome-btn-gold" style="flex:1;margin-bottom:0" onclick="fillRandomMain()">üé≤ Random Code</button>
      </div>
      <div class="welcome-error" id="choiceError"></div>
      <button class="welcome-btn welcome-btn-primary" onclick="handleCode()">Continue</button>
      <p class="welcome-small" style="margin-top:12px">Enter a new code to create a calendar, or an existing code to join one.</p>
    </div>

    <div id="stepCreated" style="display:none">
      <p style="margin-bottom:12px">Your calendar code is:</p>
      <div class="welcome-code" id="newCode"></div>
      <p class="welcome-small">Share this code with your friends so they can join!</p>
      <button class="welcome-btn welcome-btn-primary" style="margin-top:20px" onclick="enterCalendar()">Enter Calendar</button>
    </div>

    <div id="stepJoin" style="display:none">
      <p style="margin-bottom:12px">Calendar found! üéâ</p>
      <div class="welcome-code" id="joinFoundCode"></div>
      <p class="welcome-small" id="joinMemberCount"></p>
      <button class="welcome-btn welcome-btn-primary" style="margin-top:20px" onclick="confirmJoin()">Join Calendar</button>
      <button class="welcome-back-btn" onclick="showChoice()">‚Üê Back</button>
    </div>
  </div>
</div>

<div id="appContainer" style="display:none">
  <header>
    <div class="header-left">
      <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <div class="logo">
        <div class="logo-icon">üìÖ</div>
        <h1>Connect Friends</h1>
      </div>
    </div>
    <div class="user-area">
      <div class="header-code" id="headerCode" onclick="copyCode()" title="Click to copy code"></div>
      <select class="user-select" id="currentUser"></select>
      <button class="notification-bell" onclick="toggleNotifPanel()">üîî</button>
      <button class="leave-btn" onclick="leaveCalendar()">Leave</button>
    </div>
  </header>

  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <div class="app">
    <div class="sidebar" id="sidebar">
      <button class="sidebar-close" onclick="closeSidebar()">‚úï</button>
      <div>
        <div class="share-box">
          <div class="share-label">CALENDAR CODE</div>
          <div class="share-code" id="sidebarCode" onclick="copyCode()"></div>
          <div class="share-hint">Click to copy ¬∑ Share with friends</div>
        </div>
      </div>
      <div>
        <div class="section-title">Members</div>
        <div class="member-list" id="memberList"></div>
        <div class="add-member-input">
          <input type="text" id="newMemberName" placeholder="Add member..." onkeydown="if(event.key==='Enter')addMember()">
          <button onclick="addMember()">+</button>
        </div>
      </div>
      <div>
        <div class="section-title">Upcoming Together</div>
        <div id="upcomingEvents"></div>
      </div>
    </div>

    <div class="main">
      <div class="cal-header">
        <h2 id="calTitle"></h2>
        <div class="cal-nav">
          <button onclick="changeMonth(-1)">‚óÄ</button>
          <button onclick="goToday()">‚óè</button>
          <button onclick="changeMonth(1)">‚ñ∂</button>
        </div>
      </div>
      <div class="cal-grid" id="calGrid"></div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="eventModal">
  <div class="modal">
    <h3 id="modalTitle">New Event</h3>
    <div class="form-group"><label>Event Title</label><input type="text" id="evTitle" placeholder="e.g. Team Standup"></div>
    <div class="form-group"><label>Date</label><input type="date" id="evDate"></div>
    <div class="form-group" style="display:flex;gap:10px">
      <div style="flex:1"><label>Start Time</label><input type="time" id="evStart" value="09:00"></div>
      <div style="flex:1"><label>End Time</label><input type="time" id="evEnd" value="10:00"></div>
    </div>
    <div class="form-group"><label>Description</label><textarea id="evDesc" placeholder="Optional details..."></textarea></div>
    <div class="form-group"><label>People</label><div class="people-checkboxes" id="evPeople"></div></div>
    <div class="form-group"><label>Color</label><div class="color-options" id="evColor"></div></div>
    <div class="form-group"><label>Reminder</label>
      <div class="reminder-options">
        <label><input type="radio" name="reminder" value="0" checked>None</label>
        <label><input type="radio" name="reminder" value="5">5 min</label>
        <label><input type="radio" name="reminder" value="15">15 min</label>
        <label><input type="radio" name="reminder" value="30">30 min</label>
        <label><input type="radio" name="reminder" value="60">1 hour</label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-danger" id="deleteBtn" onclick="deleteEvent()" style="display:none">üóë</button>
      <button class="btn btn-primary" onclick="saveEvent()">Save Event</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <div class="event-detail-header">
      <div class="event-color-dot" id="detColor"></div>
      <h3 id="detTitle" style="margin-bottom:0"></h3>
    </div>
    <div class="event-detail-time" id="detTime"></div>
    <div class="event-detail-desc" id="detDesc"></div>
    <div class="event-detail-reminder" id="detReminder"></div>
    <div class="rsvp-section">
      <div class="section-title" style="margin-bottom:10px">Your RSVP</div>
      <div class="rsvp-buttons" id="rsvpButtons">
        <div class="rsvp-btn going" onclick="setRSVP('going')">‚úì Going</div>
        <div class="rsvp-btn maybe" onclick="setRSVP('maybe')">? Maybe</div>
        <div class="rsvp-btn cant" onclick="setRSVP('cant')">‚úï Can't</div>
      </div>
      <div class="section-title" style="margin-bottom:8px">Responses</div>
      <div class="rsvp-summary" id="rsvpSummary"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeDetail()">Close</button>
      <button class="btn btn-primary" onclick="editFromDetail()">Edit</button>
    </div>
  </div>
</div>

<script>
const COLORS = ['#43215F','#5a3478','#C0392B','#27AE60','#2980B9','#D4A017','#E67E22','#8E44AD'];
const MEMBER_COLORS = ['#43215F','#2980B9','#27AE60','#D4A017','#C0392B','#E67E22','#8E44AD','#5a3478'];
const ST = window.storage;

let calCode = '';
let calData = { members:[], events:[], nextMemberId:1, nextEventId:1 };
let currentUserId = null;
let currentUserName = '';
let editingEventId = null;
let selectedColor = COLORS[0];
let currentDetailEventId = null;
let reminderTimers = [];

const today = new Date();
let viewMonth = today.getMonth(), viewYear = today.getFullYear();

function capitalize(str) {
  return str.toUpperCase();
}

function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let c = '';
  for(let i=0;i<6;i++) c += chars[Math.floor(Math.random()*chars.length)];
  return c;
}

function fmt(y,m,d) { return new Date(y,m,d).toISOString().split('T')[0]; }

function showToast(title, msg, isReminder) {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast' + (isReminder ? ' reminder' : '');
  t.innerHTML = `<span class="toast-icon">${isReminder?'‚è∞':'üîî'}</span><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div></div>`;
  c.appendChild(t);
  setTimeout(() => t.remove(), 5000);
}

async function saveCalendar() {
  for(let attempt = 0; attempt < 3; attempt++) {
    try {
      const result = await ST.set('cal-' + calCode, JSON.stringify(calData), true);
      if(result) return true;
    } catch(e) {
      console.error('Save attempt ' + (attempt+1) + ' failed:', e);
      if(attempt < 2) await new Promise(r => setTimeout(r, 1000));
    }
  }
  showToast('‚ö†Ô∏è Save Failed', 'Could not save. Check your connection and try again.');
  return false;
}

async function loadCalendar(code) {
  try {
    const r = await ST.get('cal-' + code, true);
    if(r && r.value) { calData = JSON.parse(r.value); return true; }
    return false;
  } catch(e) { return false; }
}

// --- Welcome flow ---
function showChoice() {
  document.getElementById('stepChoice').style.display = '';
  document.getElementById('stepJoin').style.display = 'none';
  document.getElementById('stepCreated').style.display = 'none';
  document.getElementById('choiceError').style.display = 'none';
}

function fillRandomMain() {
  document.getElementById('codeInput').value = genCode();
}

async function handleCode() {
  const name = capitalize(document.getElementById('yourName').value.trim());
  if(!name) { document.getElementById('yourName').focus(); return; }
  document.getElementById('yourName').value = name;
  currentUserName = name;

  let code = document.getElementById('codeInput').value.trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
  if(code.length < 3 || code.length > 10) {
    document.getElementById('choiceError').textContent = 'Code must be 3‚Äì10 letters/numbers.';
    document.getElementById('choiceError').style.display = '';
    return;
  }
  document.getElementById('choiceError').style.display = 'none';

  const exists = await loadCalendar(code);

  if(exists) {
    calCode = code;
    const existing = calData.members.find(m => m.name.toLowerCase() === name.toLowerCase());
    if(existing) {
      currentUserId = existing.id;
      enterCalendar();
    } else {
      document.getElementById('joinFoundCode').textContent = code;
      document.getElementById('joinMemberCount').textContent = `${calData.members.length} member${calData.members.length!==1?'s':''} already in this calendar`;
      document.getElementById('stepChoice').style.display = 'none';
      document.getElementById('stepJoin').style.display = '';
    }
  } else {
    calCode = code;
    calData = { members:[{id:1, name:name, color:MEMBER_COLORS[0]}], events:[], nextMemberId:2, nextEventId:1 };
    currentUserId = 1;
    await saveCalendar();
    // Verify save worked by reading it back
    const verified = await loadCalendar(code);
    if(!verified) {
      showToast('‚ö†Ô∏è Storage Issue', 'Calendar created but may not persist. Try again if needed.');
    }
    document.getElementById('newCode').textContent = calCode;
    document.getElementById('stepChoice').style.display = 'none';
    document.getElementById('stepCreated').style.display = '';
  }
}

async function confirmJoin() {
  await loadCalendar(calCode);
  const existing = calData.members.find(m => m.name.toLowerCase() === currentUserName.toLowerCase());
  if(existing) {
    currentUserId = existing.id;
  } else {
    const newId = calData.nextMemberId++;
    calData.members.push({id:newId, name:currentUserName, color:MEMBER_COLORS[calData.members.length % MEMBER_COLORS.length]});
    currentUserId = newId;
    await saveCalendar();
  }
  enterCalendar();
}

function enterCalendar() {
  document.getElementById('welcomeScreen').style.display = 'none';
  document.getElementById('appContainer').style.display = '';
  document.getElementById('headerCode').textContent = calCode;
  document.getElementById('sidebarCode').textContent = calCode;
  renderAll();
  scheduleReminders();
}

function leaveCalendar() {
  document.getElementById('appContainer').style.display = 'none';
  document.getElementById('welcomeScreen').style.display = '';
  showChoice();
  document.getElementById('yourName').value = currentUserName;
  document.getElementById('codeInput').value = '';
  calCode = '';
  calData = { members:[], events:[], nextMemberId:1, nextEventId:1 };
  currentUserId = null;
  reminderTimers.forEach(t => clearTimeout(t));
  reminderTimers = [];
}

function copyCode() {
  navigator.clipboard.writeText(calCode).then(() => {
    showToast('Code Copied!', `${calCode} copied to clipboard`);
  }).catch(() => { showToast('Calendar Code', calCode); });
}

// --- Sidebar ---
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('active');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('active');
}

// --- Members ---
function renderMembers() {
  const ml = document.getElementById('memberList');
  const us = document.getElementById('currentUser');
  ml.innerHTML = calData.members.length ? calData.members.map(m => `
    <div class="member">
      <div class="member-avatar" style="background:${m.color}">${m.name.charAt(0).toUpperCase()}</div>
      <div style="flex:1"><div class="member-name">${capitalize(m.name)}</div><div class="member-status">${m.id===currentUserId?'You':'Member'}</div></div>
      ${m.id!==currentUserId?`<button onclick="removeMember(${m.id})" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:16px;padding:4px 8px;border-radius:8px;transition:0.2s" title="Remove member">‚úï</button>`:''}
    </div>`).join('') : '<p style="font-size:13px;color:var(--text2)">No members yet</p>';
  us.innerHTML = calData.members.map(m => `<option value="${m.id}" ${m.id===currentUserId?'selected':''}>${capitalize(m.name)}</option>`).join('');
  us.onchange = e => { if(e.target.value) { currentUserId = +e.target.value; renderAll(); } };
}

async function addMember() {
  const inp = document.getElementById('newMemberName');
  const n = capitalize(inp.value.trim());
  if(!n) return;
  await loadCalendar(calCode);
  const newId = calData.nextMemberId++;
  calData.members.push({id:newId, name:n, color:MEMBER_COLORS[calData.members.length % MEMBER_COLORS.length]});
  await saveCalendar();
  inp.value = '';
  renderAll();
}

async function removeMember(id) {
  await loadCalendar(calCode);
  const member = calData.members.find(m => m.id === id);
  if(!member) return;
  calData.members = calData.members.filter(m => m.id !== id);
  // Remove from all events
  calData.events.forEach(ev => {
    ev.people = ev.people.filter(pid => pid !== id);
    delete ev.rsvp[id];
  });
  // Remove events with no people left
  calData.events = calData.events.filter(ev => ev.people.length > 0);
  await saveCalendar();
  renderAll();
}

// --- Upcoming ---
function renderUpcoming() {
  if(!currentUserId) { document.getElementById('upcomingEvents').innerHTML=''; return; }
  const now = new Date();
  const upcoming = calData.events
    .filter(e => e.people.length > 1 && e.people.includes(currentUserId))
    .filter(e => new Date(e.date+'T'+e.start) >= new Date(now.toDateString()))
    .sort((a,b) => new Date(a.date+'T'+a.start) - new Date(b.date+'T'+b.start))
    .slice(0,5);
  document.getElementById('upcomingEvents').innerHTML = upcoming.length ? upcoming.map(e => {
    const ppl = e.people.map(pid => calData.members.find(m=>m.id===pid)).filter(Boolean).map(m=>capitalize(m.name));
    const gc = e.people.filter(pid => e.rsvp[pid]==='going').length;
    const mc = e.people.filter(pid => e.rsvp[pid]==='maybe').length;
    const cc = e.people.filter(pid => e.rsvp[pid]==='cant').length;
    const dt = new Date(e.date+'T'+e.start);
    return `<div class="upcoming-event" onclick="showDetail(${e.id})" style="border-left-color:${e.color}">
      <div class="ue-title">${e.title}</div>
      <div class="ue-time">${dt.toLocaleDateString('en',{weekday:'short',month:'short',day:'numeric'})} ¬∑ ${e.start}-${e.end}</div>
      <div class="ue-people">üë• ${ppl.join(', ')}</div>
      <div class="ue-rsvp">
        ${gc?`<span class="ue-rsvp-tag" style="background:rgba(39,174,96,0.1);color:var(--going)">‚úì${gc}</span>`:''}
        ${mc?`<span class="ue-rsvp-tag" style="background:rgba(230,214,168,0.4);color:var(--warning)">?${mc}</span>`:''}
        ${cc?`<span class="ue-rsvp-tag" style="background:rgba(192,57,43,0.1);color:var(--cant)">‚úï${cc}</span>`:''}
      </div>
    </div>`;
  }).join('') : '<p style="font-size:13px;color:var(--text2)">No upcoming group events</p>';
}

// --- Calendar ---
function renderCalendar() {
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calTitle').textContent = `${months[viewMonth]} ${viewYear}`;
  const grid = document.getElementById('calGrid');
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let html = days.map(d => `<div class="cal-day-name">${d}</div>`).join('');
  const last = new Date(viewYear, viewMonth+1, 0);
  const startDay = new Date(viewYear, viewMonth, 1).getDay();
  const prevLast = new Date(viewYear, viewMonth, 0).getDate();

  for(let i=startDay-1;i>=0;i--) html += calDayHTML(prevLast-i, fmt(viewYear,viewMonth-1,prevLast-i), true);
  for(let i=1;i<=last.getDate();i++) {
    const dt = fmt(viewYear,viewMonth,i);
    const isToday = i===today.getDate() && viewMonth===today.getMonth() && viewYear===today.getFullYear();
    html += calDayHTML(i, dt, false, isToday);
  }
  const rem = (7-(startDay+last.getDate())%7)%7;
  for(let i=1;i<=rem;i++) html += calDayHTML(i, fmt(viewYear,viewMonth+1,i), true);
  grid.innerHTML = html;
}

function calDayHTML(dayNum, dateStr, otherMonth, isToday) {
  const dayEvents = calData.events.filter(e=>e.date===dateStr).slice(0,3);
  const cls = ['cal-day'];
  if(otherMonth) cls.push('other-month');
  if(isToday) cls.push('today');
  return `<div class="${cls.join(' ')}" onclick="openModal('${dateStr}')">
    <div class="day-num">${dayNum}</div>
    ${dayEvents.map(e => {
      const r = currentUserId?e.rsvp[currentUserId]:null;
      const rd = r==='going'?'‚úì':r==='maybe'?'?':r==='cant'?'‚úï':'';
      return `<div class="cal-event" style="background:${e.color}" onclick="event.stopPropagation();showDetail(${e.id})">${rd?rd+' ':''}${e.title}</div>`;
    }).join('')}
    ${calData.events.filter(e=>e.date===dateStr).length>3?`<div style="font-size:10px;color:var(--text2)">+${calData.events.filter(e=>e.date===dateStr).length-3} more</div>`:''}
  </div>`;
}

function changeMonth(d) { viewMonth+=d; if(viewMonth>11){viewMonth=0;viewYear++} if(viewMonth<0){viewMonth=11;viewYear--} renderCalendar(); }
function goToday() { viewMonth=today.getMonth(); viewYear=today.getFullYear(); renderCalendar(); }

// --- Event modal ---
function openModal(dateStr) {
  if(!calData.members.length) return;
  editingEventId = null;
  document.getElementById('modalTitle').textContent = 'New Event';
  document.getElementById('deleteBtn').style.display = 'none';
  document.getElementById('evTitle').value = '';
  document.getElementById('evDate').value = dateStr;
  document.getElementById('evStart').value = '09:00';
  document.getElementById('evEnd').value = '10:00';
  document.getElementById('evDesc').value = '';
  document.querySelector('input[name="reminder"][value="0"]').checked = true;
  selectedColor = COLORS[0];
  renderColorPicker();
  renderPeopleCheckboxes(currentUserId ? [currentUserId] : []);
  document.getElementById('eventModal').classList.add('active');
}

function renderColorPicker() {
  document.getElementById('evColor').innerHTML = COLORS.map(c =>
    `<div class="color-opt ${c===selectedColor?'selected':''}" style="background:${c}" onclick="selectedColor='${c}';renderColorPicker()"></div>`
  ).join('');
}

function renderPeopleCheckboxes(selected) {
  document.getElementById('evPeople').innerHTML = calData.members.map(m =>
    `<label><input type="checkbox" value="${m.id}" ${selected.includes(m.id)?'checked':''}>${capitalize(m.name)}</label>`
  ).join('');
}

function closeModal() { document.getElementById('eventModal').classList.remove('active'); }

async function saveEvent() {
  const title = document.getElementById('evTitle').value.trim();
  const date = document.getElementById('evDate').value;
  const start = document.getElementById('evStart').value;
  const end = document.getElementById('evEnd').value;
  const desc = document.getElementById('evDesc').value.trim();
  const people = [...document.querySelectorAll('#evPeople input:checked')].map(i=>+i.value);
  const reminder = +document.querySelector('input[name="reminder"]:checked').value;

  if(!title||!date||!people.length) return;

  await loadCalendar(calCode);

  if(editingEventId) {
    const ev = calData.events.find(e=>e.id===editingEventId);
    if(ev) {
      const newRsvp = {...ev.rsvp};
      people.forEach(pid => { if(!newRsvp[pid]) newRsvp[pid] = null; });
      Object.keys(newRsvp).forEach(pid => { if(!people.includes(+pid)) delete newRsvp[pid]; });
      Object.assign(ev, {title,date,start,end,desc,people,color:selectedColor,reminder,rsvp:newRsvp});
    }
  } else {
    const rsvp = {};
    people.forEach(pid => { rsvp[pid] = pid===currentUserId ? 'going' : null; });
    calData.events.push({id:calData.nextEventId++, title, date, start, end, desc, people, color:selectedColor, reminder, rsvp});
  }
  await saveCalendar();
  closeModal();
  renderAll();
}

async function deleteEvent() {
  if(!editingEventId) return;
  await loadCalendar(calCode);
  calData.events = calData.events.filter(e=>e.id!==editingEventId);
  await saveCalendar();
  closeModal();
  renderAll();
}

// --- Detail modal ---
function showDetail(id) {
  const ev = calData.events.find(e=>e.id===id);
  if(!ev) return;
  currentDetailEventId = id;
  document.getElementById('detColor').style.background = ev.color;
  document.getElementById('detTitle').textContent = ev.title;
  document.getElementById('detTime').textContent = `üìÖ ${new Date(ev.date).toLocaleDateString('en',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}  ¬∑  üïê ${ev.start} - ${ev.end}`;
  document.getElementById('detDesc').textContent = ev.desc || 'No description';
  document.getElementById('detReminder').textContent = ev.reminder ? `‚è∞ Reminder: ${ev.reminder} min before` : '';

  const isInvited = currentUserId && ev.people.includes(currentUserId);
  const btns = document.getElementById('rsvpButtons');
  if(isInvited) {
    btns.style.display = 'flex';
    btns.querySelectorAll('.rsvp-btn').forEach(b=>b.classList.remove('active'));
    const myRsvp = ev.rsvp[currentUserId];
    if(myRsvp) { const a = btns.querySelector(`.rsvp-btn.${myRsvp}`); if(a) a.classList.add('active'); }
  } else { btns.style.display = 'none'; }
  renderRSVPSummary(ev);
  document.getElementById('detailModal').classList.add('active');
}

function renderRSVPSummary(ev) {
  const groups = {going:[], maybe:[], cant:[], pending:[]};
  ev.people.forEach(pid => {
    const m = calData.members.find(mm=>mm.id===pid);
    if(!m) return;
    (groups[ev.rsvp[pid]] || groups.pending).push(m);
  });
  const rg = (label, cls, arr) => {
    if(!arr.length) return '';
    return `<div class="rsvp-group"><span class="rsvp-group-label ${cls}">${label} (${arr.length})</span>${arr.map(m=>`<span class="rsvp-person"><span class="rp-dot" style="background:${m.color}"></span>${capitalize(m.name)}</span>`).join('')}</div>`;
  };
  document.getElementById('rsvpSummary').innerHTML =
    rg('Going','going-label',groups.going) +
    rg('Maybe','maybe-label',groups.maybe) +
    rg("Can't",'cant-label',groups.cant) +
    rg('Pending','pending-label',groups.pending);
}

async function setRSVP(status) {
  if(!currentDetailEventId||!currentUserId) return;
  await loadCalendar(calCode);
  const ev = calData.events.find(e=>e.id===currentDetailEventId);
  if(!ev||!ev.people.includes(currentUserId)) return;
  ev.rsvp[currentUserId] = status;
  await saveCalendar();
  document.querySelectorAll('#rsvpButtons .rsvp-btn').forEach(b=>b.classList.remove('active'));
  const a = document.querySelector(`#rsvpButtons .rsvp-btn.${status}`);
  if(a) a.classList.add('active');
  renderRSVPSummary(ev);
  renderCalendar();
  renderUpcoming();
}

function closeDetail() { document.getElementById('detailModal').classList.remove('active'); currentDetailEventId=null; }

function editFromDetail() {
  const id = currentDetailEventId;
  closeDetail();
  const ev = calData.events.find(e=>e.id===id);
  if(!ev) return;
  editingEventId = id;
  document.getElementById('modalTitle').textContent = 'Edit Event';
  document.getElementById('deleteBtn').style.display = '';
  document.getElementById('evTitle').value = ev.title;
  document.getElementById('evDate').value = ev.date;
  document.getElementById('evStart').value = ev.start;
  document.getElementById('evEnd').value = ev.end;
  document.getElementById('evDesc').value = ev.desc;
  selectedColor = ev.color;
  renderColorPicker();
  renderPeopleCheckboxes(ev.people);
  const ri = document.querySelector(`input[name="reminder"][value="${ev.reminder}"]`);
  if(ri) ri.checked = true;
  document.getElementById('eventModal').classList.add('active');
}

function toggleNotifPanel() {
  if(!currentUserId) return;
  const pending = calData.events.filter(e=>e.people.includes(currentUserId)&&!e.rsvp[currentUserId]);
  if(pending.length) {
    pending.forEach(e => showToast('RSVP Needed',`Respond to "${e.title}"`,true));
  } else {
    showToast('All Clear','No pending RSVPs');
  }
}

function scheduleReminders() {
  reminderTimers.forEach(t=>clearTimeout(t));
  reminderTimers = [];
  if(!currentUserId) return;
  const now = new Date();
  calData.events.forEach(ev => {
    if(!ev.reminder||!ev.people.includes(currentUserId)||ev.people.length<2||ev.rsvp[currentUserId]==='cant') return;
    const diff = new Date(ev.date+'T'+ev.start).getTime() - ev.reminder*60000 - now.getTime();
    if(diff>0 && diff<86400000) {
      reminderTimers.push(setTimeout(() => {
        const ppl = ev.people.filter(p=>p!==currentUserId).map(pid=>calData.members.find(m=>m.id===pid)).filter(Boolean).map(m=>capitalize(m.name)).join(', ');
        showToast(`‚è∞ ${ev.title}`,`Starting in ${ev.reminder} min with ${ppl}`,true);
      }, diff));
    }
  });
}

setInterval(async () => {
  if(!calCode) return;
  try {
    const r = await ST.get('cal-'+calCode, true);
    if(r && r.value) { calData = JSON.parse(r.value); renderAll(); }
  } catch(e) {}
}, 15000);

function renderAll() { renderMembers(); renderCalendar(); renderUpcoming(); }
</script>
</body>
</html>
